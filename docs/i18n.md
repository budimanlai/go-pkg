# I18n Package

The `i18n` package provides internationalization (i18n) management for Go applications with Fiber framework integration, using go-i18n library.

## Features

- üåç Multi-language support with go-i18n v2
- üîå Automatic Fiber middleware integration
- üìù Locale file management (JSON format)
- üîÑ Language detection from Accept-Language header
- üíæ Localizer caching for performance
- üß© Modular locale files support
- üéØ Field-level translations for validators

## Installation

This package is part of `github.com/budimanlai/go-pkg`. Import it as:

```go
import "github.com/budimanlai/go-pkg/i18n"
```

### Dependencies

```bash
go get github.com/nicksnyder/go-i18n/v2/i18n
go get golang.org/x/text/language
go get github.com/gofiber/fiber/v2
```

## Quick Start

### 1. Setup Locale Files

Create locale files in `../locales/` directory:

**locales/en.json:**
```json
{
  "welcome": "Welcome to our application",
  "user.created": "User created successfully",
  "error.not_found": "Resource not found"
}
```

**locales/id.json:**
```json
{
  "welcome": "Selamat datang di aplikasi kami",
  "user.created": "Pengguna berhasil dibuat",
  "error.not_found": "Resource tidak ditemukan"
}
```

### 2. Initialize I18n Manager

```go
package main

import (
    "github.com/budimanlai/go-pkg/i18n"
    "github.com/gofiber/fiber/v2"
    "golang.org/x/text/language"
)

func main() {
    app := fiber.New()
    
    // Configure i18n
    config := i18n.I18nConfig{
        DefaultLanguage: language.English,
        SupportedLangs:  []string{"en", "id", "zh"},
        LocalesPath:     "./locales",
    }
    
    // Option 1: Create i18n manager with Fiber middleware
    i18nManager, err := i18n.NewI18nManagerWithFiber(app, config)
    if err != nil {
        panic(err)
    }
    
    // Option 2: Create i18n manager and add middleware manually
    // i18nManager, err := i18n.NewI18nManager(config)
    // if err != nil {
    //     panic(err)
    // }
    // app.Use(i18n.I18nMiddleware(config))
    
    app.Listen(":3000")
}
```

### 3. Use Translations in Handlers

```go
app.Get("/welcome", func(c *fiber.Ctx) error {
    // Get language from context
    lang := i18n.GetLanguage(c)
    
    // Translate message
    msg := i18nManager.Translate(lang, "welcome", nil)
    
    return c.JSON(fiber.Map{"message": msg})
})
```

## API Reference

### Types

#### I18nConfig
```go
type I18nConfig struct {
    DefaultLanguage language.Tag
    SupportedLangs  []string
    LocalesPath     string
    Modules         []string
}
```

Configuration for i18n initialization.

**Fields:**
- `DefaultLanguage`: Default language tag (fallback language)
- `SupportedLangs`: List of supported language codes (e.g., ["en", "id", "zh"])
- `LocalesPath`: Path to locales directory (default: "../locales")
- `Modules`: Optional module names for modular locale files

#### I18nManager
```go
type I18nManager struct {
    Bundle          *i18n.Bundle
    Localizer       map[string]*i18n.Localizer
    DefaultLanguage string
}
```

Manages i18n operations and localizer caching.

### Functions

#### NewI18nManager
```go
func NewI18nManager(config I18nConfig) (*I18nManager, error)
```
Creates a new I18nManager without Fiber middleware.

**Example:**
```go
i18nManager, err := i18n.NewI18nManager(i18n.I18nConfig{
    DefaultLanguage: language.English,
    SupportedLangs:  []string{"en", "id"},
    LocalesPath:     "./locales",
})
```

#### NewI18nManagerWithFiber
```go
func NewI18nManagerWithFiber(app *fiber.App, config I18nConfig) (*I18nManager, error)
```
Creates I18nManager and automatically registers middleware with Fiber app.

**Example:**
```go
app := fiber.New()
i18nManager, err := i18n.NewI18nManagerWithFiber(app, config)
```

#### Translate
```go
func (m *I18nManager) Translate(lang, messageID string, template interface{}) string
```
Translates a message ID to the specified language with optional template data.

**Example:**
```go
// Simple translation
msg := i18nManager.Translate("id", "welcome", nil)

// With template data
msg := i18nManager.Translate("id", "user_greeting", map[string]string{
    "Name": "John",
})
// If locale has: "user_greeting": "Hello, {{.Name}}!"
// Returns: "Hello, John!"
```

#### TranslateWithConfig
```go
func (m *I18nManager) TranslateWithConfig(lang string, c *i18n.LocalizeConfig) string
```
Translates using a LocalizeConfig for advanced options.

**Example:**
```go
msg := i18nManager.TranslateWithConfig("id", &i18n.LocalizeConfig{
    MessageID: "welcome_message",
    TemplateData: map[string]string{
        "Name": "John",
    },
})
```

#### GetLanguage
```go
func GetLanguage(c *fiber.Ctx) string
```
Extracts language code from Fiber context locals set by I18nMiddleware.

**Example:**
```go
app.Get("/info", func(c *fiber.Ctx) error {
    lang := i18n.GetLanguage(c)
    fmt.Println("User language:", lang) // Output: en, id, or zh
    return c.SendString("Language: " + lang)
})
```

### Middleware

#### I18nMiddleware
```go
func I18nMiddleware(config I18nConfig) fiber.Handler
```
Fiber middleware that detects user language from request.

**Language detection order:**
1. Query parameter `?lang=id`
2. Accept-Language header
3. Default language from config

**Example:**
```go
config := i18n.I18nConfig{
    DefaultLanguage: language.English,
    SupportedLangs:  []string{"en", "id", "zh"},
    LocalesPath:     "./locales",
}

app.Use(i18n.I18nMiddleware(config))
```

## Usage Examples

### Basic Translation

```go
app := fiber.New()

config := i18n.I18nConfig{
    DefaultLanguage: language.English,
    SupportedLangs:  []string{"en", "id", "zh"},
    LocalesPath:     "./locales",
}

i18nManager, _ := i18n.NewI18nManagerWithFiber(app, config)

app.Get("/hello", func(c *fiber.Ctx) error {
    lang := i18n.GetLanguage(c)
    greeting := i18nManager.Translate(lang, "greeting", nil)
    
    return c.JSON(fiber.Map{
        "message": greeting,
        "lang":    lang,
    })
})
```

**Request:**
```bash
curl -H "Accept-Language: id" http://localhost:3000/hello
# Response: {"message":"Halo","lang":"id"}

curl -H "Accept-Language: en" http://localhost:3000/hello
# Response: {"message":"Hello","lang":"en"}

curl "http://localhost:3000/hello?lang=zh"
# Response: {"message":"‰Ω†Â•Ω","lang":"zh"}
```

### Translation with Parameters

```go
// locales/en.json
{
  "user_welcome": "Welcome back, {{.Name}}! You have {{.Count}} new messages."
}

// locales/id.json
{
  "user_welcome": "Selamat datang kembali, {{.Name}}! Anda memiliki {{.Count}} pesan baru."
}

// Handler
app.Get("/user/:id", func(c *fiber.Ctx) error {
    lang := i18n.GetLanguage(c)
    msg := i18nManager.Translate(lang, "user_welcome", map[string]interface{}{
        "Name":  "John",
        "Count": 5,
    })
    return c.JSON(fiber.Map{"message": msg})
})
```

**Request with English:**
```bash
curl -H "Accept-Language: en" http://localhost:3000/user/123
# Response: {"message":"Welcome back, John! You have 5 new messages."}
```

**Request with Indonesian:**
```bash
curl -H "Accept-Language: id" http://localhost:3000/user/123
# Response: {"message":"Selamat datang kembali, John! Anda memiliki 5 pesan baru."}
```

### Modular Locale Files

```go
config := i18n.I18nConfig{
    DefaultLanguage: language.English,
    SupportedLangs:  []string{"en", "id"},
    LocalesPath:     "./locales",
    Modules:         []string{"auth", "user", "product"},
}

// File structure:
// locales/
//   en/
//     auth.json
//     user.json
//     product.json
//   id/
//     auth.json
//     user.json
//     product.json
```

### Integration with Validator

```go
import (
    "github.com/budimanlai/go-pkg/i18n"
    "github.com/budimanlai/go-pkg/validator"
    "github.com/budimanlai/go-pkg/response"
)

// Setup i18n
i18nManager, _ := i18n.NewI18nManagerWithFiber(app, config)

// Link i18n with validator and response packages
validator.SetI18nManager(i18nManager)
response.SetI18nManager(i18nManager)

// Validator will now use i18n for error messages
type CreateUserRequest struct {
    Email string `json:"email" validate:"required,email"`
    Name  string `json:"name" validate:"required,min=3"`
}

app.Post("/users", func(c *fiber.Ctx) error {
    var req CreateUserRequest
    if err := c.BodyParser(&req); err != nil {
        return response.BadRequestI18n(c, "invalid_request_body", nil)
    }
    
    // Validate with i18n error messages
    if err := validator.ValidateStructWithContext(c, req); err != nil {
        return response.ValidationErrorI18n(c, err)
    }
    
    // Create user...
    return response.SuccessI18n(c, "user_created", req)
})
```

### Language Detection Examples

```go
// Priority 1: Query parameter
curl "http://localhost:3000/hello?lang=id"

// Priority 2: Accept-Language header
curl -H "Accept-Language: id" http://localhost:3000/hello

// Priority 3: Default language (if none specified)
curl http://localhost:3000/hello
```

## Best Practices

1. **Locale Path**: Use consistent locale paths across your application (e.g., `./locales`)
2. **Default Language**: Always set a sensible default language as fallback
3. **Key Naming**: Use dot notation for hierarchical keys (e.g., `user.created`, `error.not_found`)
4. **Parameter Templates**: Use Go template syntax for dynamic values: `{{.VariableName}}`
5. **Modular Files**: Split large translation files into modules for better organization
6. **Caching**: I18nManager automatically caches localizers for performance
7. **Error Handling**: Always check errors from NewI18nManager/NewI18nManagerWithFiber

## Testing

Run tests with:
```bash
go test ./i18n/ -v
```

## License

This package is part of the go-pkg project and follows the same license.
